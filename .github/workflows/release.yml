name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versions.outputs.version }}
      tag: ${{ steps.versions.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Verify versions
        id: versions
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import sys

          tag = os.environ["TAG"]
          if not tag.startswith("v"):
            raise SystemExit("Tag must start with v, e.g. v1.0.0")
          version = tag[1:]

          try:
            import tomllib
          except ModuleNotFoundError as exc:
            raise SystemExit("Python 3.11+ is required for tomllib") from exc

          cargo_text = pathlib.Path("Cargo.toml").read_text()
          cargo_data = tomllib.loads(cargo_text)
          cargo_version = cargo_data.get("package", {}).get("version")
          if not cargo_version:
            raise SystemExit("Cargo.toml version not found")

          meta_version = json.loads(pathlib.Path("packaging/npm/package.json").read_text())["version"]
          platform_paths = [
            "packaging/npm-platforms/darwin-arm64/package.json",
            "packaging/npm-platforms/darwin-x64/package.json",
            "packaging/npm-platforms/linux-x64/package.json",
            "packaging/npm-platforms/linux-arm64/package.json",
            "packaging/npm-platforms/win32-x64/package.json",
          ]
          for path in platform_paths:
            pkg_version = json.loads(pathlib.Path(path).read_text())["version"]
            if pkg_version != version:
              raise SystemExit(f"{path} version mismatch: {pkg_version} != {version}")

          if cargo_version != version or meta_version != version:
            raise SystemExit(f"Version mismatch: Cargo={cargo_version}, npm={meta_version}, tag={version}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"version={version}\\n")
            f.write(f"tag={tag}\\n")
          PY

  publish-platforms:
    needs: verify
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            pkg: darwin-arm64
            bin: codex-sdd
          - os: macos-15-intel
            target: x86_64-apple-darwin
            pkg: darwin-x64
            bin: codex-sdd
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            pkg: linux-x64
            bin: codex-sdd
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            pkg: linux-arm64
            bin: codex-sdd
            cross: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            pkg: win32-x64
            bin: codex-sdd.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: Install cross toolchain
        if: matrix.cross == true
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
      - name: Build binary
        shell: bash
        run: cargo build --release --target ${{ matrix.target }}
      - name: Prepare package
        shell: bash
        run: |
          PKG_DIR="packaging/npm-platforms/${{ matrix.pkg }}"
          BIN_SRC="target/${{ matrix.target }}/release/${{ matrix.bin }}"
          mkdir -p "$PKG_DIR/bin"
          cp "$BIN_SRC" "$PKG_DIR/bin/${{ matrix.bin }}"
          if [ "${{ matrix.bin }}" = "codex-sdd" ]; then
            chmod +x "$PKG_DIR/bin/${{ matrix.bin }}"
          fi
      - name: Package release asset
        id: asset
        shell: bash
        run: |
          ASSET="codex-sdd-${{ matrix.pkg }}.tar.gz"
          tar -czf "$ASSET" -C "packaging/npm-platforms/${{ matrix.pkg }}/bin" "${{ matrix.bin }}"
          echo "asset=$ASSET" >> "$GITHUB_OUTPUT"
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.asset.outputs.asset }}
      - name: Publish npm package
        working-directory: packaging/npm-platforms/${{ matrix.pkg }}
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-meta:
    needs: [verify, publish-platforms]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: Publish meta package
        working-directory: packaging/npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
